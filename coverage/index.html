<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Slanger</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.5.3/jquery-1.6.2.min.js' type='text/javascript'></script>
    <script src='./assets/0.5.3/jquery.dataTables.min.js' type='text/javascript'></script>
    <script src='./assets/0.5.3/fancybox/jquery.fancybox-1.3.1.pack.js' type='text/javascript'></script>
    <script src='./assets/0.5.3/jquery.timeago.js' type='text/javascript'></script>
    <script src='./assets/0.5.3/jquery.url.js' type='text/javascript'></script>
    <script src='./assets/0.5.3/highlight.pack.js' type='text/javascript'></script>
    <script src='./assets/0.5.3/app.js' type='text/javascript'></script>
    <link href='./assets/0.5.3/stylesheet.css' media='screen, projection, print' rel='stylesheet' type='text/css'>
    <link href='./assets/0.5.3/highlight.css' media='screen, projection, print' rel='stylesheet' type='text/css'>
    <link href='./assets/0.5.3/fancybox/jquery.fancybox-1.3.1.css' media='screen, projection, print' rel='stylesheet' type='text/css'>
    <link href='./assets/0.5.3/smoothness/jquery-ui-1.8.4.custom.css' media='screen, projection, print' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="./assets/0.5.3/favicon_yellow.png" />
    <link rel="icon" type="image/png" href="./assets/0.5.3/favicon.png" />
  </head>

  <body>
    <div id="loading">
      <img src="./assets/0.5.3/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" style="display:none;">
      <div class="timestamp">Generated <abbr class="timeago" title="2012-05-13T21:30:35+01:00">2012-05-13T21:30:35+01:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent"><span class="yellow">83.91%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         1.27
       </span>
    </span> hits/line)
  </h2>
  <a name="AllFiles"></a>
  <div>
    <b>6</b> files in total.
    <b>174</b> relevant lines.
    <span class="green"><b>146</b> lines covered</span> and
    <span class="red"><b>28</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>

      <tr>
        <td class="strong"><a href="#787b80103a80ab0eb3ae7bbc5e53c63bc3f24f3e" class="src_link" title="lib/slanger/handler.rb">lib/slanger/handler.rb</a></td>
        <td class="red strong">42.22 %</td>
        <td>83</td>
        <td>45</td>
        <td>19</td>
        <td>26</td>
        <td>0.4</td>
      </tr>

      <tr>
        <td class="strong"><a href="#b09d5d3581ebe42f88f9eba7e18cb80cee007e35" class="src_link" title="spec/integration/integration_spec.rb">spec/integration/integration_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>31</td>
        <td>16</td>
        <td>16</td>
        <td>0</td>
        <td>1.5</td>
      </tr>

      <tr>
        <td class="strong"><a href="#9475f908a4ca4dae3d435c8070e444582a98d0a7" class="src_link" title="spec/integration/presence_channel_spec.rb">spec/integration/presence_channel_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>156</td>
        <td>55</td>
        <td>55</td>
        <td>0</td>
        <td>2.4</td>
      </tr>

      <tr>
        <td class="strong"><a href="#2991da51d3ad09b3c19d5d3a1cd38abcc91ace33" class="src_link" title="spec/integration/private_channel_spec.rb">spec/integration/private_channel_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>80</td>
        <td>35</td>
        <td>35</td>
        <td>0</td>
        <td>1.4</td>
      </tr>

      <tr>
        <td class="strong"><a href="#e1e3f2be3aec3da763cc1e77b34c4989c0340d72" class="src_link" title="spec/integration/replaced_handler_spec.rb">spec/integration/replaced_handler_spec.rb</a></td>
        <td class="yellow strong">84.62 %</td>
        <td>24</td>
        <td>13</td>
        <td>11</td>
        <td>2</td>
        <td>0.9</td>
      </tr>

      <tr>
        <td class="strong"><a href="#6c32f8e16c3e5229150575f2eadd566e40cf1048" class="src_link" title="spec/integration/ssl_spec.rb">spec/integration/ssl_spec.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>18</td>
        <td>10</td>
        <td>10</td>
        <td>0</td>
        <td>1.0</td>
      </tr>

    </tbody>
  </table>
</div>



      </div>

      <div id="footer">
        Generated by <a href="http://github.com/colszowka/simplecov">simplecov</a> v0.6.4
        and simplecov-html v0.5.3<br/>
        using RSpec
      </div>

      <div class="source_files">

        <div class="source_table" id="787b80103a80ab0eb3ae7bbc5e53c63bc3f24f3e">
  <div class="header">
    <h3>lib/slanger/handler.rb</h3>
    <h4><span class="red">42.22 %</span> covered</h4>
    <div>
      <b>45</b> relevant lines.
      <span class="green"><b>19</b> lines covered</span> and
      <span class="red"><b>26</b> lines missed.</span>
    </div>
  </div>

  <pre>
    <ol>

        <li class="never" data-hits="" data-linenumber="1">


          <code class="ruby"># Handler class.</code>
        </li>

        <li class="never" data-hits="" data-linenumber="2">


          <code class="ruby"># Handles a client connected via a websocket connection.</code>
        </li>

        <li class="never" data-hits="" data-linenumber="3">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>

          <code class="ruby">require 'active_support/core_ext/hash'</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>

          <code class="ruby">require 'securerandom'</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>

          <code class="ruby">require 'signature'</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>

          <code class="ruby">require 'fiber'</code>
        </li>

        <li class="never" data-hits="" data-linenumber="8">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>

          <code class="ruby">module Slanger</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>

          <code class="ruby">  class Handler</code>
        </li>

        <li class="never" data-hits="" data-linenumber="11">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>

          <code class="ruby">    attr_accessor :connection</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>

          <code class="ruby">    delegate :error, :send_payload, to: :connection</code>
        </li>

        <li class="never" data-hits="" data-linenumber="14">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>

          <code class="ruby">    def initialize(socket)</code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="16">


          <code class="ruby">      @socket        = socket</code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="17">


          <code class="ruby">      @connection    = Connection.new(@socket)</code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="18">


          <code class="ruby">      @subscriptions = {}</code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="19">


          <code class="ruby">      authenticate</code>
        </li>

        <li class="never" data-hits="" data-linenumber="20">


          <code class="ruby">    end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="21">


          <code class="ruby"></code>
        </li>

        <li class="never" data-hits="" data-linenumber="22">


          <code class="ruby">    # Dispatches message handling to method with same name as</code>
        </li>

        <li class="never" data-hits="" data-linenumber="23">


          <code class="ruby">    # the event name</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>

          <code class="ruby">    def onmessage(msg)</code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="25">


          <code class="ruby">      msg   = JSON.parse msg</code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="26">


          <code class="ruby">      event = msg['event'].gsub(/^pusher:/, 'pusher_')</code>
        </li>

        <li class="never" data-hits="" data-linenumber="27">


          <code class="ruby"></code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="28">


          <code class="ruby">      if event =~ /^client-/</code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="29">


          <code class="ruby">        msg['socket_id'] = connection.socket_id</code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="30">


          <code class="ruby">        Channel.send_client_message msg</code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="31">


          <code class="ruby">      elsif respond_to? event, true</code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="32">


          <code class="ruby">        send event, msg</code>
        </li>

        <li class="never" data-hits="" data-linenumber="33">


          <code class="ruby">      end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="34">


          <code class="ruby"></code>
        </li>

        <li class="never" data-hits="" data-linenumber="35">


          <code class="ruby">    rescue JSON::ParserError</code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="36">


          <code class="ruby">      error({ code: 5001, message: &quot;Invalid JSON&quot; })</code>
        </li>

        <li class="never" data-hits="" data-linenumber="37">


          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="38">


          <code class="ruby">      error({ code: 500, message: &quot;#{e.message}\n #{e.backtrace}&quot; })</code>
        </li>

        <li class="never" data-hits="" data-linenumber="39">


          <code class="ruby">    end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="40">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>

          <code class="ruby">    def onclose</code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="42">


          <code class="ruby">      @subscriptions.each { |c, s| Channel.unsubscribe c, s }</code>
        </li>

        <li class="never" data-hits="" data-linenumber="43">


          <code class="ruby">    end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="44">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>

          <code class="ruby">    def authenticate</code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="46">


          <code class="ruby">      return connection.establish if valid_app_key?</code>
        </li>

        <li class="never" data-hits="" data-linenumber="47">


          <code class="ruby"></code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="48">


          <code class="ruby">      error({ code: 4001, message: &quot;Could not find app by key #{app_key}&quot; })</code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="49">


          <code class="ruby">      @socket.close_websocket</code>
        </li>

        <li class="never" data-hits="" data-linenumber="50">


          <code class="ruby">    end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="51">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>

          <code class="ruby">    def pusher_ping(msg)</code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="53">


          <code class="ruby">      send_payload nil, 'pusher:ping'</code>
        </li>

        <li class="never" data-hits="" data-linenumber="54">


          <code class="ruby">    end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="55">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>

          <code class="ruby">    def pusher_pong msg; end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="57">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>

          <code class="ruby">    def pusher_subscribe(msg)</code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="59">


          <code class="ruby">      channel_id = msg['data']['channel']</code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="60">


          <code class="ruby">      klass      = subscription_klass channel_id</code>
        </li>

        <li class="never" data-hits="" data-linenumber="61">


          <code class="ruby"></code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="62">


          <code class="ruby">      @subscriptions[channel_id] = klass.new(connection.socket, connection.socket_id, msg).subscribe</code>
        </li>

        <li class="never" data-hits="" data-linenumber="63">


          <code class="ruby">    end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="64">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>

          <code class="ruby">    private</code>
        </li>

        <li class="never" data-hits="" data-linenumber="66">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>

          <code class="ruby">    def app_key</code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="68">


          <code class="ruby">      @socket.request['path'].split(/\W/)[2]</code>
        </li>

        <li class="never" data-hits="" data-linenumber="69">


          <code class="ruby">    end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="70">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>

          <code class="ruby">    def valid_app_key?</code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="72">


          <code class="ruby">      Slanger::Config.app_key == app_key</code>
        </li>

        <li class="never" data-hits="" data-linenumber="73">


          <code class="ruby">    end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="74">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>

          <code class="ruby">    def subscription_klass channel_id</code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="76">


          <code class="ruby">      klass = channel_id.match(/^(private|presence)-/) do |match|</code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="77">


          <code class="ruby">        Slanger.const_get &quot;#{match[1]}_subscription&quot;.classify</code>
        </li>

        <li class="never" data-hits="" data-linenumber="78">


          <code class="ruby">      end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="79">


          <code class="ruby"></code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="80">


          <code class="ruby">      klass || Slanger::Subscription</code>
        </li>

        <li class="never" data-hits="" data-linenumber="81">


          <code class="ruby">    end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="82">


          <code class="ruby">  end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="83">


          <code class="ruby">end</code>
        </li>

    </ol>
  </pre>
</div>

        <div class="source_table" id="b09d5d3581ebe42f88f9eba7e18cb80cee007e35">
  <div class="header">
    <h3>spec/integration/integration_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>16</b> relevant lines.
      <span class="green"><b>16</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>

  <pre>
    <ol>

        <li class="never" data-hits="" data-linenumber="1">


          <code class="ruby">#encoding: utf-8</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>

          <code class="ruby">require 'spec_helper'</code>
        </li>

        <li class="never" data-hits="" data-linenumber="3">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>

          <code class="ruby">describe 'Integration' do</code>
        </li>

        <li class="never" data-hits="" data-linenumber="5">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="3" data-linenumber="6">
          <span class="hits">3</span>

          <code class="ruby">  before(:each) { start_slanger }</code>
        </li>

        <li class="never" data-hits="" data-linenumber="7">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>

          <code class="ruby">  context &quot;connecting with invalid credentials&quot; do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>

          <code class="ruby">    it &quot;sends an error message&quot; do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>

          <code class="ruby">      messages = em_stream(key: 'bogus_key') do |websocket, messages|</code>
        </li>

        <li class="covered" data-hits="2" data-linenumber="11">
          <span class="hits">2</span>

          <code class="ruby">        websocket.callback { EM.stop }</code>
        </li>

        <li class="never" data-hits="" data-linenumber="12">


          <code class="ruby">      end</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>

          <code class="ruby">      messages.should have_attributes count: 1, last_event: 'pusher:error',</code>
        </li>

        <li class="never" data-hits="" data-linenumber="14">


          <code class="ruby">        connection_established: false, id_present: false</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>

          <code class="ruby">      messages.first['data'] == 'Could not find app by key bogus_key'</code>
        </li>

        <li class="never" data-hits="" data-linenumber="16">


          <code class="ruby">    end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="17">


          <code class="ruby">  end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="18">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>

          <code class="ruby">  context &quot;given invalid JSON as input&quot; do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>

          <code class="ruby">    it 'should not crash' do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>

          <code class="ruby">      messages  = em_stream do |websocket, messages|</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>

          <code class="ruby">        websocket.callback do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>

          <code class="ruby">          websocket.send(&quot;{ event: 'pusher:subscribe', data: { channel: 'MY_CHANNEL'} }23123&quot;)</code>
        </li>

        <li class="covered" data-hits="2" data-linenumber="24">
          <span class="hits">2</span>

          <code class="ruby">          EM.next_tick { EM.stop }</code>
        </li>

        <li class="never" data-hits="" data-linenumber="25">


          <code class="ruby">        end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="26">


          <code class="ruby">      end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="27">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="5" data-linenumber="28">
          <span class="hits">5</span>

          <code class="ruby">      EM.run { new_websocket.tap { |u| u.stream { EM.next_tick { EM.stop } } }}</code>
        </li>

        <li class="never" data-hits="" data-linenumber="29">


          <code class="ruby">    end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="30">


          <code class="ruby">  end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="31">


          <code class="ruby">end</code>
        </li>

    </ol>
  </pre>
</div>

        <div class="source_table" id="9475f908a4ca4dae3d435c8070e444582a98d0a7">
  <div class="header">
    <h3>spec/integration/presence_channel_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>55</b> relevant lines.
      <span class="green"><b>55</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>

  <pre>
    <ol>

        <li class="never" data-hits="" data-linenumber="1">


          <code class="ruby">#encoding: utf-8</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>

          <code class="ruby">require 'spec/spec_helper'</code>
        </li>

        <li class="never" data-hits="" data-linenumber="3">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>

          <code class="ruby">describe 'Integration' do</code>
        </li>

        <li class="never" data-hits="" data-linenumber="5">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="6" data-linenumber="6">
          <span class="hits">6</span>

          <code class="ruby">  before(:each) { start_slanger }</code>
        </li>

        <li class="never" data-hits="" data-linenumber="7">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>

          <code class="ruby">  describe 'presence channels:' do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>

          <code class="ruby">    context 'subscribing without channel data' do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>

          <code class="ruby">      context 'and bogus authentication credentials' do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>

          <code class="ruby">        it 'sends back an error message' do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>

          <code class="ruby">          messages  = em_stream do |websocket, messages|</code>
        </li>

        <li class="covered" data-hits="2" data-linenumber="13">
          <span class="hits">2</span>

          <code class="ruby">            case messages.length</code>
        </li>

        <li class="never" data-hits="" data-linenumber="14">


          <code class="ruby">            when 1</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>

          <code class="ruby">              websocket.send({ event: 'pusher:subscribe', data: { channel: 'presence-channel', auth: 'bogus' } }.to_json)</code>
        </li>

        <li class="never" data-hits="" data-linenumber="16">


          <code class="ruby">            else</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>

          <code class="ruby">              EM.stop</code>
        </li>

        <li class="never" data-hits="" data-linenumber="18">


          <code class="ruby">            end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="19">


          <code class="ruby">          end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="20">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>

          <code class="ruby">          messages.should have_attributes connection_established: true, id_present: true,</code>
        </li>

        <li class="never" data-hits="" data-linenumber="22">


          <code class="ruby">            count: 2,</code>
        </li>

        <li class="never" data-hits="" data-linenumber="23">


          <code class="ruby">            last_event: 'pusher:error'</code>
        </li>

        <li class="never" data-hits="" data-linenumber="24">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>

          <code class="ruby">          messages.last['data']['message'].=~(/^Invalid signature: Expected HMAC SHA256 hex digest of/).should be_true</code>
        </li>

        <li class="never" data-hits="" data-linenumber="26">


          <code class="ruby">        end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="27">


          <code class="ruby">      end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="28">


          <code class="ruby">    end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="29">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>

          <code class="ruby">    context 'subscribing with channel data' do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>

          <code class="ruby">      context 'and bogus authentication credentials' do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>

          <code class="ruby">        it 'sends back an error message' do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>

          <code class="ruby">          messages  = em_stream do |websocket, messages|</code>
        </li>

        <li class="covered" data-hits="2" data-linenumber="34">
          <span class="hits">2</span>

          <code class="ruby">            case messages.length</code>
        </li>

        <li class="never" data-hits="" data-linenumber="35">


          <code class="ruby">            when 1</code>
        </li>

        <li class="never" data-hits="" data-linenumber="36">


          <code class="ruby">               send_subscribe( user: websocket,</code>
        </li>

        <li class="never" data-hits="" data-linenumber="37">


          <code class="ruby">                               user_id: '0f177369a3b71275d25ab1b44db9f95f',</code>
        </li>

        <li class="never" data-hits="" data-linenumber="38">


          <code class="ruby">                               name: 'SG',</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>

          <code class="ruby">                               message: {data: {socket_id: 'bogus'}}.with_indifferent_access)</code>
        </li>

        <li class="never" data-hits="" data-linenumber="40">


          <code class="ruby">           else</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>

          <code class="ruby">              EM.stop</code>
        </li>

        <li class="never" data-hits="" data-linenumber="42">


          <code class="ruby">            end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="43">


          <code class="ruby">          end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="44">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>

          <code class="ruby">          messages.should have_attributes first_event: 'pusher:connection_established', count: 2,</code>
        </li>

        <li class="never" data-hits="" data-linenumber="46">


          <code class="ruby">            id_present: true</code>
        </li>

        <li class="never" data-hits="" data-linenumber="47">


          <code class="ruby"></code>
        </li>

        <li class="never" data-hits="" data-linenumber="48">


          <code class="ruby">          # Channel id should be in the payload</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>

          <code class="ruby">          messages.last['event'].should == 'pusher:error'</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>

          <code class="ruby">          messages.last['data']['message'].=~(/^Invalid signature: Expected HMAC SHA256 hex digest of/).should be_true</code>
        </li>

        <li class="never" data-hits="" data-linenumber="51">


          <code class="ruby">        end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="52">


          <code class="ruby">      end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="53">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>

          <code class="ruby">      context 'with genuine authentication credentials'  do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>

          <code class="ruby">        it 'sends back a success message' do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>

          <code class="ruby">          messages  = em_stream do |websocket, messages|</code>
        </li>

        <li class="covered" data-hits="2" data-linenumber="57">
          <span class="hits">2</span>

          <code class="ruby">            case messages.length</code>
        </li>

        <li class="never" data-hits="" data-linenumber="58">


          <code class="ruby">            when 1</code>
        </li>

        <li class="never" data-hits="" data-linenumber="59">


          <code class="ruby">              send_subscribe( user: websocket,</code>
        </li>

        <li class="never" data-hits="" data-linenumber="60">


          <code class="ruby">                              user_id: '0f177369a3b71275d25ab1b44db9f95f',</code>
        </li>

        <li class="never" data-hits="" data-linenumber="61">


          <code class="ruby">                              name: 'SG',</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>

          <code class="ruby">                              message: messages.first)</code>
        </li>

        <li class="never" data-hits="" data-linenumber="63">


          <code class="ruby">            else</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>

          <code class="ruby">              EM.stop</code>
        </li>

        <li class="never" data-hits="" data-linenumber="65">


          <code class="ruby">            end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="66">


          <code class="ruby">          end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="67">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>

          <code class="ruby">          messages.should have_attributes connection_established: true, count: 2</code>
        </li>

        <li class="never" data-hits="" data-linenumber="69">


          <code class="ruby"></code>
        </li>

        <li class="never" data-hits="" data-linenumber="70">


          <code class="ruby">          messages.last.should == {&quot;channel&quot;=&gt;&quot;presence-channel&quot;,</code>
        </li>

        <li class="never" data-hits="" data-linenumber="71">


          <code class="ruby">                                   &quot;event&quot;=&gt;&quot;pusher_internal:subscription_succeeded&quot;,</code>
        </li>

        <li class="never" data-hits="" data-linenumber="72">


          <code class="ruby">                                   &quot;data&quot;=&gt;{&quot;presence&quot;=&gt;</code>
        </li>

        <li class="never" data-hits="" data-linenumber="73">


          <code class="ruby">                                            {&quot;count&quot;=&gt;1,</code>
        </li>

        <li class="never" data-hits="" data-linenumber="74">


          <code class="ruby">                                             &quot;ids&quot;=&gt;[&quot;0f177369a3b71275d25ab1b44db9f95f&quot;],</code>
        </li>

        <li class="never" data-hits="" data-linenumber="75">


          <code class="ruby">                                             &quot;hash&quot;=&gt;</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>

          <code class="ruby">                                            {&quot;0f177369a3b71275d25ab1b44db9f95f&quot;=&gt;{&quot;name&quot;=&gt;&quot;SG&quot;}}}}}</code>
        </li>

        <li class="never" data-hits="" data-linenumber="77">


          <code class="ruby">        end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="78">


          <code class="ruby"></code>
        </li>

        <li class="never" data-hits="" data-linenumber="79">


          <code class="ruby"></code>
        </li>

        <li class="never" data-hits="" data-linenumber="80">


          <code class="ruby"></code>
        </li>

        <li class="never" data-hits="" data-linenumber="81">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>

          <code class="ruby">        context 'with more than one subscriber subscribed to the channel' do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>

          <code class="ruby">          it 'sends a member added message to the existing subscribers' do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>

          <code class="ruby">            messages  = em_stream do |user1, messages|</code>
        </li>

        <li class="covered" data-hits="3" data-linenumber="85">
          <span class="hits">3</span>

          <code class="ruby">              case messages.length</code>
        </li>

        <li class="never" data-hits="" data-linenumber="86">


          <code class="ruby">              when 1</code>
        </li>

        <li class="never" data-hits="" data-linenumber="87">


          <code class="ruby">                send_subscribe(user: user1,</code>
        </li>

        <li class="never" data-hits="" data-linenumber="88">


          <code class="ruby">                               user_id: '0f177369a3b71275d25ab1b44db9f95f',</code>
        </li>

        <li class="never" data-hits="" data-linenumber="89">


          <code class="ruby">                               name: 'SG',</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>

          <code class="ruby">                               message: messages.first</code>
        </li>

        <li class="never" data-hits="" data-linenumber="91">


          <code class="ruby">                              )</code>
        </li>

        <li class="never" data-hits="" data-linenumber="92">


          <code class="ruby"></code>
        </li>

        <li class="never" data-hits="" data-linenumber="93">


          <code class="ruby">              when 2</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>

          <code class="ruby">                new_websocket.tap do |u|</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>

          <code class="ruby">                  u.stream do |message|</code>
        </li>

        <li class="never" data-hits="" data-linenumber="96">


          <code class="ruby">                    send_subscribe({user: u,</code>
        </li>

        <li class="never" data-hits="" data-linenumber="97">


          <code class="ruby">                      user_id: '37960509766262569d504f02a0ee986d',</code>
        </li>

        <li class="never" data-hits="" data-linenumber="98">


          <code class="ruby">                      name: 'CHROME',</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>

          <code class="ruby">                      message: JSON.parse(message)})</code>
        </li>

        <li class="never" data-hits="" data-linenumber="100">


          <code class="ruby">                  end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="101">


          <code class="ruby">                end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="102">


          <code class="ruby">              else</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>

          <code class="ruby">                EM.stop</code>
        </li>

        <li class="never" data-hits="" data-linenumber="104">


          <code class="ruby">              end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="105">


          <code class="ruby"></code>
        </li>

        <li class="never" data-hits="" data-linenumber="106">


          <code class="ruby">            end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="107">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>

          <code class="ruby">            messages.should have_attributes connection_established: true, count: 3</code>
        </li>

        <li class="never" data-hits="" data-linenumber="109">


          <code class="ruby">            # Channel id should be in the payload</code>
        </li>

        <li class="never" data-hits="" data-linenumber="110">


          <code class="ruby">            messages[1].should == {&quot;channel&quot;=&gt;&quot;presence-channel&quot;, &quot;event&quot;=&gt;&quot;pusher_internal:subscription_succeeded&quot;,</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>

          <code class="ruby">                                     &quot;data&quot;=&gt;{&quot;presence&quot;=&gt;{&quot;count&quot;=&gt;1, &quot;ids&quot;=&gt;[&quot;0f177369a3b71275d25ab1b44db9f95f&quot;], &quot;hash&quot;=&gt;{&quot;0f177369a3b71275d25ab1b44db9f95f&quot;=&gt;{&quot;name&quot;=&gt;&quot;SG&quot;}}}}}</code>
        </li>

        <li class="never" data-hits="" data-linenumber="112">


          <code class="ruby"></code>
        </li>

        <li class="never" data-hits="" data-linenumber="113">


          <code class="ruby">            messages.last.should == {&quot;channel&quot;=&gt;&quot;presence-channel&quot;, &quot;event&quot;=&gt;&quot;pusher_internal:member_added&quot;,</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="114">
          <span class="hits">1</span>

          <code class="ruby">                                     &quot;data&quot;=&gt;{&quot;user_id&quot;=&gt;&quot;37960509766262569d504f02a0ee986d&quot;, &quot;user_info&quot;=&gt;{&quot;name&quot;=&gt;&quot;CHROME&quot;}}}</code>
        </li>

        <li class="never" data-hits="" data-linenumber="115">


          <code class="ruby">          end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="116">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>

          <code class="ruby">          it 'does not send multiple member added and member removed messages if one subscriber opens multiple connections, i.e. multiple browser tabs.' do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="118">
          <span class="hits">1</span>

          <code class="ruby">            messages  = em_stream do |user1, messages|</code>
        </li>

        <li class="covered" data-hits="4" data-linenumber="119">
          <span class="hits">4</span>

          <code class="ruby">              case messages.length</code>
        </li>

        <li class="never" data-hits="" data-linenumber="120">


          <code class="ruby">              when 1</code>
        </li>

        <li class="never" data-hits="" data-linenumber="121">


          <code class="ruby">                send_subscribe(user: user1,</code>
        </li>

        <li class="never" data-hits="" data-linenumber="122">


          <code class="ruby">                               user_id: '0f177369a3b71275d25ab1b44db9f95f',</code>
        </li>

        <li class="never" data-hits="" data-linenumber="123">


          <code class="ruby">                               name: 'SG',</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>

          <code class="ruby">                               message: messages.first)</code>
        </li>

        <li class="never" data-hits="" data-linenumber="125">


          <code class="ruby"></code>
        </li>

        <li class="never" data-hits="" data-linenumber="126">


          <code class="ruby">              when 2</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>

          <code class="ruby">                10.times do</code>
        </li>

        <li class="covered" data-hits="10" data-linenumber="128">
          <span class="hits">10</span>

          <code class="ruby">                  new_websocket.tap do |u|</code>
        </li>

        <li class="covered" data-hits="10" data-linenumber="129">
          <span class="hits">10</span>

          <code class="ruby">                    u.stream do |message|</code>
        </li>

        <li class="never" data-hits="" data-linenumber="130">


          <code class="ruby">                      # remove stream callback</code>
        </li>

        <li class="never" data-hits="" data-linenumber="131">


          <code class="ruby">                      ## close the connection in the next tick as soon as subscription is acknowledged</code>
        </li>

        <li class="covered" data-hits="30" data-linenumber="132">
          <span class="hits">30</span>

          <code class="ruby">                      u.stream { EM.next_tick { u.close_connection } }</code>
        </li>

        <li class="never" data-hits="" data-linenumber="133">


          <code class="ruby"></code>
        </li>

        <li class="never" data-hits="" data-linenumber="134">


          <code class="ruby">                      send_subscribe({ user: u,</code>
        </li>

        <li class="never" data-hits="" data-linenumber="135">


          <code class="ruby">                         user_id: '37960509766262569d504f02a0ee986d',</code>
        </li>

        <li class="never" data-hits="" data-linenumber="136">


          <code class="ruby">                         name: 'CHROME',</code>
        </li>

        <li class="covered" data-hits="10" data-linenumber="137">
          <span class="hits">10</span>

          <code class="ruby">                         message: JSON.parse(message)})</code>
        </li>

        <li class="never" data-hits="" data-linenumber="138">


          <code class="ruby">                    end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="139">


          <code class="ruby">                  end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="140">


          <code class="ruby">                end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="141">


          <code class="ruby">              when 4</code>
        </li>

        <li class="covered" data-hits="2" data-linenumber="142">
          <span class="hits">2</span>

          <code class="ruby">                EM.next_tick { EM.stop }</code>
        </li>

        <li class="never" data-hits="" data-linenumber="143">


          <code class="ruby">              end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="144">


          <code class="ruby"></code>
        </li>

        <li class="never" data-hits="" data-linenumber="145">


          <code class="ruby">            end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="146">


          <code class="ruby"></code>
        </li>

        <li class="never" data-hits="" data-linenumber="147">


          <code class="ruby">            # There should only be one set of presence messages sent to the refernce user for the second user.</code>
        </li>

        <li class="covered" data-hits="5" data-linenumber="148">
          <span class="hits">5</span>

          <code class="ruby">            messages.one? { |message| message['event'] == 'pusher_internal:member_added'   &amp;&amp; message['data']['user_id'] == '37960509766262569d504f02a0ee986d' }.should be_true</code>
        </li>

        <li class="covered" data-hits="5" data-linenumber="149">
          <span class="hits">5</span>

          <code class="ruby">            messages.one? { |message| message['event'] == 'pusher_internal:member_removed' &amp;&amp; message['data']['user_id'] == '37960509766262569d504f02a0ee986d' }.should be_true</code>
        </li>

        <li class="never" data-hits="" data-linenumber="150">


          <code class="ruby"></code>
        </li>

        <li class="never" data-hits="" data-linenumber="151">


          <code class="ruby">          end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="152">


          <code class="ruby">        end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="153">


          <code class="ruby">      end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="154">


          <code class="ruby">    end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="155">


          <code class="ruby">  end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="156">


          <code class="ruby">end</code>
        </li>

    </ol>
  </pre>
</div>

        <div class="source_table" id="2991da51d3ad09b3c19d5d3a1cd38abcc91ace33">
  <div class="header">
    <h3>spec/integration/private_channel_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>35</b> relevant lines.
      <span class="green"><b>35</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>

  <pre>
    <ol>

        <li class="never" data-hits="" data-linenumber="1">


          <code class="ruby">#encoding: utf-8</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>

          <code class="ruby">require 'spec/spec_helper'</code>
        </li>

        <li class="never" data-hits="" data-linenumber="3">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>

          <code class="ruby">describe 'Integration' do</code>
        </li>

        <li class="never" data-hits="" data-linenumber="5">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="4" data-linenumber="6">
          <span class="hits">4</span>

          <code class="ruby">  before(:each) { start_slanger }</code>
        </li>

        <li class="never" data-hits="" data-linenumber="7">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>

          <code class="ruby">  describe 'private channels' do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>

          <code class="ruby">    context 'with valid authentication credentials:' do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>

          <code class="ruby">      it 'accepts the subscription request' do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>

          <code class="ruby">        messages  = em_stream do |websocket, messages|</code>
        </li>

        <li class="covered" data-hits="2" data-linenumber="12">
          <span class="hits">2</span>

          <code class="ruby">          case messages.length</code>
        </li>

        <li class="never" data-hits="" data-linenumber="13">


          <code class="ruby">          when 1</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>

          <code class="ruby">            private_channel websocket, messages.first</code>
        </li>

        <li class="never" data-hits="" data-linenumber="15">


          <code class="ruby">          else</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>

          <code class="ruby">            EM.stop</code>
        </li>

        <li class="never" data-hits="" data-linenumber="17">


          <code class="ruby">          end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="18">


          <code class="ruby">        end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="19">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>

          <code class="ruby">        messages.should have_attributes connection_established: true,</code>
        </li>

        <li class="never" data-hits="" data-linenumber="21">


          <code class="ruby">          count: 2,</code>
        </li>

        <li class="never" data-hits="" data-linenumber="22">


          <code class="ruby">          id_present: true,</code>
        </li>

        <li class="never" data-hits="" data-linenumber="23">


          <code class="ruby">          last_event: 'pusher_internal:subscription_succeeded'</code>
        </li>

        <li class="never" data-hits="" data-linenumber="24">


          <code class="ruby">      end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="25">


          <code class="ruby">    end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="26">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>

          <code class="ruby">    context 'with bogus authentication credentials:' do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>

          <code class="ruby">      it 'sends back an error message' do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>

          <code class="ruby">        messages  = em_stream do |websocket, messages|</code>
        </li>

        <li class="covered" data-hits="2" data-linenumber="30">
          <span class="hits">2</span>

          <code class="ruby">          case messages.length</code>
        </li>

        <li class="never" data-hits="" data-linenumber="31">


          <code class="ruby">          when 1</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>

          <code class="ruby">            websocket.send({ event: 'pusher:subscribe',</code>
        </li>

        <li class="never" data-hits="" data-linenumber="33">


          <code class="ruby">                             data: { channel: 'private-channel',</code>
        </li>

        <li class="never" data-hits="" data-linenumber="34">


          <code class="ruby">                                     auth: 'bogus' } }.to_json)</code>
        </li>

        <li class="never" data-hits="" data-linenumber="35">


          <code class="ruby">          else</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>

          <code class="ruby">            EM.stop</code>
        </li>

        <li class="never" data-hits="" data-linenumber="37">


          <code class="ruby">          end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="38">


          <code class="ruby">        end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="39">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>

          <code class="ruby">        messages.should have_attributes connection_established: true, count: 2, id_present: true, last_event:</code>
        </li>

        <li class="never" data-hits="" data-linenumber="41">


          <code class="ruby">          'pusher:error'</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>

          <code class="ruby">        messages.last['data']['message'].=~(/^Invalid signature: Expected HMAC SHA256 hex digest of/).should be_true</code>
        </li>

        <li class="never" data-hits="" data-linenumber="43">


          <code class="ruby">      end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="44">


          <code class="ruby">    end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="45">


          <code class="ruby"></code>
        </li>

        <li class="never" data-hits="" data-linenumber="46">


          <code class="ruby"></code>
        </li>

        <li class="never" data-hits="" data-linenumber="47">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>

          <code class="ruby">    describe 'client events' do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>

          <code class="ruby">      it &quot;sends event to other channel subscribers&quot; do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>

          <code class="ruby">        client1_messages, client2_messages  = [], []</code>
        </li>

        <li class="never" data-hits="" data-linenumber="51">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>

          <code class="ruby">        em_thread do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>

          <code class="ruby">          client1, client2 = new_websocket, new_websocket</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>

          <code class="ruby">          client2_messages, client1_messages = [], []</code>
        </li>

        <li class="never" data-hits="" data-linenumber="55">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>

          <code class="ruby">          stream(client1, client1_messages) do |message|</code>
        </li>

        <li class="covered" data-hits="3" data-linenumber="57">
          <span class="hits">3</span>

          <code class="ruby">            case client1_messages.length</code>
        </li>

        <li class="never" data-hits="" data-linenumber="58">


          <code class="ruby">            when 1</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>

          <code class="ruby">              private_channel client1, client1_messages.first</code>
        </li>

        <li class="never" data-hits="" data-linenumber="60">


          <code class="ruby">            when 3</code>
        </li>

        <li class="covered" data-hits="2" data-linenumber="61">
          <span class="hits">2</span>

          <code class="ruby">              EM.next_tick { EM.stop }</code>
        </li>

        <li class="never" data-hits="" data-linenumber="62">


          <code class="ruby">            end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="63">


          <code class="ruby">          end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="64">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>

          <code class="ruby">          stream(client2, client2_messages) do |message|</code>
        </li>

        <li class="covered" data-hits="2" data-linenumber="66">
          <span class="hits">2</span>

          <code class="ruby">            case client2_messages.length</code>
        </li>

        <li class="never" data-hits="" data-linenumber="67">


          <code class="ruby">            when 1</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>

          <code class="ruby">              private_channel client2, client2_messages.first</code>
        </li>

        <li class="never" data-hits="" data-linenumber="69">


          <code class="ruby">            when 2</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>

          <code class="ruby">              client2.send({ event: 'client-something', data: { some: 'stuff' }, channel: 'private-channel' }.to_json)</code>
        </li>

        <li class="never" data-hits="" data-linenumber="71">


          <code class="ruby">            end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="72">


          <code class="ruby">          end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="73">


          <code class="ruby">        end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="74">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="4" data-linenumber="75">
          <span class="hits">4</span>

          <code class="ruby">        client1_messages.one? { |m| m['event'] == 'client-something' }.should be_true</code>
        </li>

        <li class="covered" data-hits="3" data-linenumber="76">
          <span class="hits">3</span>

          <code class="ruby">        client2_messages.none?  { |m| m['event'] == 'client-something' }.should be_true</code>
        </li>

        <li class="never" data-hits="" data-linenumber="77">


          <code class="ruby">      end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="78">


          <code class="ruby">    end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="79">


          <code class="ruby">  end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="80">


          <code class="ruby">end</code>
        </li>

    </ol>
  </pre>
</div>

        <div class="source_table" id="e1e3f2be3aec3da763cc1e77b34c4989c0340d72">
  <div class="header">
    <h3>spec/integration/replaced_handler_spec.rb</h3>
    <h4><span class="yellow">84.62 %</span> covered</h4>
    <div>
      <b>13</b> relevant lines.
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>

  <pre>
    <ol>

        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>

          <code class="ruby">require 'spec/spec_helper'</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>

          <code class="ruby">require 'lib/slanger/handler.rb'</code>
        </li>

        <li class="never" data-hits="" data-linenumber="3">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>

          <code class="ruby">class ReplacedHandler &lt; Slanger::Handler</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>

          <code class="ruby">  def authenticate</code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="6">


          <code class="ruby">    super</code>
        </li>

        <li class="missed" data-hits="0" data-linenumber="7">


          <code class="ruby">    send_payload nil, 'pusher:info', { message: &quot;Welcome!&quot; }</code>
        </li>

        <li class="never" data-hits="" data-linenumber="8">


          <code class="ruby">  end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="9">


          <code class="ruby">end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="10">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>

          <code class="ruby">describe 'Replacable handler' do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>

          <code class="ruby">  it 'says welcome' do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>

          <code class="ruby">    start_slanger_with_options socket_handler: ReplacedHandler</code>
        </li>

        <li class="never" data-hits="" data-linenumber="14">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>

          <code class="ruby">    msgs = em_stream do |websocket, messages|</code>
        </li>

        <li class="covered" data-hits="2" data-linenumber="16">
          <span class="hits">2</span>

          <code class="ruby">      if messages.length == 2</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>

          <code class="ruby">        EM.stop</code>
        </li>

        <li class="never" data-hits="" data-linenumber="18">


          <code class="ruby">      end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="19">


          <code class="ruby">    end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="20">


          <code class="ruby"></code>
        </li>

        <li class="never" data-hits="" data-linenumber="21">


          <code class="ruby">    msgs.last.should == { &quot;channel&quot; =&gt; nil, &quot;event&quot; =&gt; &quot;pusher:info&quot;,</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>

          <code class="ruby">                          &quot;data&quot; =&gt; { &quot;message&quot; =&gt; &quot;Welcome!&quot; } }</code>
        </li>

        <li class="never" data-hits="" data-linenumber="23">


          <code class="ruby">  end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="24">


          <code class="ruby">end</code>
        </li>

    </ol>
  </pre>
</div>

        <div class="source_table" id="6c32f8e16c3e5229150575f2eadd566e40cf1048">
  <div class="header">
    <h3>spec/integration/ssl_spec.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>10</b> relevant lines.
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>

  <pre>
    <ol>

        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>

          <code class="ruby">require 'spec/spec_helper'</code>
        </li>

        <li class="never" data-hits="" data-linenumber="2">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>

          <code class="ruby">describe 'Integration' do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>

          <code class="ruby">  describe 'Slanger when configured to use SSL' do</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>

          <code class="ruby">    it 'encrypts the connection' do</code>
        </li>

        <li class="never" data-hits="" data-linenumber="6">


          <code class="ruby">      start_slanger_with_options tls_options: {</code>
        </li>

        <li class="never" data-hits="" data-linenumber="7">


          <code class="ruby">        cert_chain_file:  'spec/server.crt',</code>
        </li>

        <li class="never" data-hits="" data-linenumber="8">


          <code class="ruby">        private_key_file: 'spec/server.key'</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>

          <code class="ruby">      }</code>
        </li>

        <li class="never" data-hits="" data-linenumber="10">


          <code class="ruby"></code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>

          <code class="ruby">      socket                 = TCPSocket.new('0.0.0.0', 8080)</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>

          <code class="ruby">      expected_cert          = OpenSSL::X509::Certificate.new(File.open('spec/server.crt'))</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>

          <code class="ruby">      ssl_socket             = OpenSSL::SSL::SSLSocket.new(socket)</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>

          <code class="ruby">      ssl_socket.connect</code>
        </li>

        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>

          <code class="ruby">      ssl_socket.peer_cert.to_s.should == expected_cert.to_s</code>
        </li>

        <li class="never" data-hits="" data-linenumber="16">


          <code class="ruby">    end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="17">


          <code class="ruby">  end</code>
        </li>

        <li class="never" data-hits="" data-linenumber="18">


          <code class="ruby">end</code>
        </li>

    </ol>
  </pre>
</div>

      </div>
    </div>
  </body>
</html>
